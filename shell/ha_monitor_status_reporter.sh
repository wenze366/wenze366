#!/bin/bash
# ===============================================================================
# 脚本名称: ha_monitor_status_reporter.sh
# 脚本用途: GBase 监控系统HA状态仲裁器
# 部署位置: 172.16.213.100, 172.16.213.101, 172.16.213.102
#
# 功能说明:
#   1. 定期检测主监控机(104)和备监控机(105)的网络连通性
#   2. 根据连通性决定当前应使用哪个监控机
#   3. 将状态信息写入本地文件供HA调度器读取
#   4. 实现监控系统的高可用性
#
# 执行方式:
#   手动执行: bash /path/to/ha_monitor_status_reporter.sh
#   定时任务: * * * * * /path/to/ha_monitor_status_reporter.sh
#
# 依赖项:
#   - ping (网络连通性测试工具)
#
# 版本信息:
#   版本: v1.1
#   作者: 数据库运维组
#   创建日期: 2024-11-15
#   最后更新: 2025-12-24
#   更新说明: 修正监控机IP配置、优化决策逻辑
#
# 维护说明:
#   1. 必须在所有数据库节点(100/101/102)上部署
#   2. 确保/data目录有写权限
#   3. 建议每分钟执行一次,保证状态及时更新
#   4. 状态文件被HA调度器(104/105)通过SSH远程读取
#   5. 可通过查看/data/monitor.pid内容验证当前状态
# ===============================================================================

# --- 配置 ---
PRIMARY_MONITOR="172.16.213.103"
BACKUP_MONITOR="172.16.213.104"
STATE_FILE="/data/monitor.pid"
# Ping 参数：1 个包，超时 2 秒
PING_OPTS="-c 1 -W 2"

# --------------------------------------------------------
# 步骤 1: 检查 104 和 105 的连通性
# --------------------------------------------------------

# 辅助函数：执行 ping 并返回状态 (0=通, 非0=不通)
function check_ping() {
    ping $PING_OPTS "$1" > /dev/null 2>&1
    return $?
}

check_ping $PRIMARY_MONITOR
PRIMARY_STATUS=$? # 0:通, 1:不通

check_ping $BACKUP_MONITOR
BACKUP_STATUS=$?  # 0:通, 1:不通

# --------------------------------------------------------
# 步骤 2: 写入状态文件 (严格按照用户逻辑)
# --------------------------------------------------------

if [ $PRIMARY_STATUS -eq 0 ]; then
    # 只有 104 通时 (或 104 通，105 不通)
    echo "Primary ID:1000" > "$STATE_FILE"

elif [ $BACKUP_STATUS -eq 0 ]; then
    # 104 不通，且 105 通时
    echo "Backup ID:2000" > "$STATE_FILE"

else
    # 两者都不通时 (集群处于隔离状态，或监控机全宕机)
    echo "Undetermined State" > "$STATE_FILE"
fi

exit 0
